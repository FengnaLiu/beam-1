<style type="text/css">
  .head { 
    border-left:5px solid #00f;
    padding:3px 0 3px 10px;
    font-weight: bold;
  }
  .lhead { 
    border-left:5px solid #00f;
    padding:3px 0 3px 10px;
    font-size:14pt;
    font-weight: bold;
  }
</style>
[topへ](../index.html)

# ユーザ定義関数を作るときに気をつけること
分散処理の特性に気をつけよう、とのこと。ワーカーは複数できるかもだし、各transformは独立に、かつデータの受け渡しなく実行される。関数オブジェクト（`DoFn`のサブクラスとか）に関して、具体的に気をつけるべきなのは、

+ [シリアル化](https://www.ne.jp/asahi/hishidama/home/tech/java/serial.html)可能であること
+ スレッド互換であること  
マルチスレッドでも問題なく動く、の意味。用語を詳しく知りたければ[こちら](https://www.ibm.com/developerworks/jp/java/library/j-jtp09263/index.html)が参考になるかもです。
+ 必須ではないが、メソッドが冪等であること

それぞれ、詳しく見ていきます。

## <span class="head">シリアル化可能</span>
Dataflow上で実行みたいな場合、関数オブジェクトもシリアル化したのちにワーカーへ転送される。`DoFn`とかBeam SDKで提供されてるやつらはシリアル化可能なようにしてくれてるみたいだけど、こいつらを継承したサブクラスを作るときはユーザ自身がシリアル化可能であることを保証しなければいけない。シリアル化できないメンバを追加してはいけない、と言ってます。

追記

+ [Transient修飾子](http://java-code.jp/126)について  
Transient修飾子がついたメンバはシリアル化されず、またワーカーにも渡されない。たくさんのデータをシリアル化しなきゃ...、って状況を回避できるそうです。
+ 関数オブジェクトについて  
関数オブジェクトの間でdataを共有できない。  
applyしたあとだったら、関数オブジェクトはいじってもok。
+ 匿名クラスについて  
public属性の付いていないクラスのインスタンスは、そのクラスへのポインタを持っているっぽい。なので、匿名クラスを用いる場合は、実装するクラス自体がシリアル化できるように、とのこと。(普通のインスタンスに対する制約との違いが分からない...)

## <span class="head">スレッド互換性</span>
一つのワーカーからの関数オブジェクトのインスタンスへのアクセスは、一つのスレッドからになるそう。ただ、マルチスレッドで処理するようコーディングしたら、話は別ですが。。。  
Beamはスレッドセーフではないので、ユーザが独自につくったマルチスレッド処理は、自分できちんと同期処理をしてくれとのこと。  
少し話は変わりますが、staticメンバは各ワーカーに渡されないっぽいので、扱いには気をつけた方がいいかもです。ワーカー間で共有されるイメージなのでしょうか...？関数オブジェクト間でdata共有不可、ってのに反する気もしますが...

## <span class="head">冪等性</span>
必須ではないのですが関数オブジェクトが冪等であること、つまり何度呼び出されても同じ結果を返すようにしておくことが推奨されています。
失敗時のリトライだとかで、Beam SDKは関数オブジェクトの（コーディング通りの？）呼び出し回数は保証してくれないみたいです。
冪等でない関数オブジェクトもサポートされてますが、冪等にしておいた方が間違いは少ないだろうし、デバックもしやすいでしょう、とのことです。